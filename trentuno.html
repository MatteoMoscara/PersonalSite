<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gioca ora a 31</title>
    <style>
        /* --- STILE GENERALE --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- LOBBY --- */
        #lobby-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1b5e20, #000);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
        }
        
        .lobby-box {
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px;
            text-align: center; border: 2px solid #ffeb3b; width: 80%; max-width: 400px;
        }

        .lobby-row { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        input[type="number"] { padding: 5px; width: 60px; text-align: center; font-size: 18px; border-radius: 5px; border: none;}
        
        .btn-start {
            padding: 15px 30px; font-size: 20px; background: #ffeb3b; color: #000;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px;
        }

        /* --- TAVOLO --- */
        #tavolo-container {
            position: relative; width: 100vw; height: 100vh;
            display: none; justify-content: center; align-items: center;
        }

        #tavolo-gioco {
            position: relative; width: 95vmin; height: 95vmin;
            background: radial-gradient(circle, #388e3c 0%, #1b5e20 100%);
            border-radius: 50%; border: 4vmin solid #5d4037;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- AREE --- */
        #area-centrale {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40%; height: 30%;
            display: flex; justify-content: space-around; align-items: center;
            border: 2px dashed rgba(255,255,255,0.1); border-radius: 10px;
        }

        .slot-centro {
            width: 40%; height: 90%;
            background: rgba(0,0,0,0.2); border-radius: 5px; position: relative;
        }
        .label-slot { position: absolute; bottom: -20px; width: 100%; text-align: center; font-size: 12px; color: #aaa; }

        /* --- GIOCATORI --- */
        .giocatore {
            position: absolute; width: 18vmin; height: 18vmin;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.5s ease;
        }

        .avatar {
            width: 7vmin; height: 7vmin;
            background: #eee; border: 0.5vmin solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: black; font-weight: bold; font-size: 3vmin; z-index: 2;
        }

        .info-box {
            background: rgba(0,0,0,0.7); padding: 2px 8px; border-radius: 10px;
            font-size: 2.5vmin; margin-top: -1vmin; z-index: 3; color: white;
        }

        .turno-attivo .avatar { border-color: #ffeb3b; box-shadow: 0 0 25px #ffeb3b; transform: scale(1.1); }
        .turno-attivo .info-box { color: #ffeb3b; }

        /* --- CARTE --- */
        .area-carte {
            display: flex; justify-content: center; margin-top: 1vmin;
            height: 12vmin; width: 22vmin; position: relative;
        }

        .carta {
            width: 7.2vmin; height: 12vmin;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c4/Carte_napoletane_al_completo.jpg');
            background-size: 72vmin 48vmin; /* 10col * 7.2 = 72 */
            border-radius: 0.5vmin;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            position: absolute; 
            background-color: white;
        }
        
        .carta-retro {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_back_01.svg/300px-Card_back_01.svg.png');
            background-size: cover; border: 1px solid #ccc;
        }

        /* Carte Umano (Interattive) */
        .giocatore-umano .area-carte .carta {
            position: relative; margin-left: -3.5vmin; cursor: grab;
            transition: transform 0.2s, margin 0.2s;
        }
        .giocatore-umano .area-carte .carta:first-child { margin-left: 0; }
        .giocatore-umano .area-carte .carta:hover { transform: translateY(-1vmin); z-index: 10; }
        .giocatore-umano .area-carte .carta:active { cursor: grabbing; }

        /* Carta Volante (Animazione) */
        .carta-animata {
            position: fixed; z-index: 9999; pointer-events: none;
            transition: all 0.6s ease-in-out;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        /* Carta trascinata (Drag) */
        .carta-dragging {
            position: fixed !important; z-index: 9999 !important; pointer-events: none;
            transform: scale(1.1) rotate(5deg); opacity: 0.9;
        }

        /* --- BUSSATA & UI --- */
        #zona-bussa {
            position: absolute; right: 10%; bottom: 20%;
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.15);
            border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%;
            cursor: pointer; display: flex; text-align: center;
            justify-content: center; align-items: center; font-size: 11px;
            user-select: none;
        }
        #zona-bussa:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

        #animazione-bussata {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 100px;
            display: none; z-index: 500; pointer-events: none;
        }
        @keyframes knockAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* --- OVERLAY FINE GIOCO --- */
        #overlay-fine {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
        }
        #overlay-contenuto {
            background: #222; padding: 30px; border-radius: 10px;
            border: 2px solid #ffeb3b; text-align: center; min-width: 300px;
        }
        h2 { color: #ffeb3b; margin: 0 0 10px 0; font-size: 30px;}
        .risultato-riga { display: flex; justify-content: space-between; margin: 5px 0; font-size: 18px; border-bottom: 1px solid #444;}
        
        #tutorial-msg {
            position: absolute; bottom: 5%; width: 100%; text-align: center;
            font-size: 2.5vmin; color: rgba(255,255,255,0.8); pointer-events: none;
            background: rgba(0,0,0,0.5); padding: 5px 0;
        }

    </style>
</head>
<body>

    <div id="lobby-screen">
        <div class="lobby-box">
            <h1 style="color:#ffeb3b; margin-top:0;">Gioca ora a 31</h1>
            
            <div class="lobby-row">
                <label>Totale Giocatori (2-6):</label>
                <input type="number" id="input-totale" value="4" min="2" max="6" onchange="checkInputs()">
            </div>
            
            <div class="lobby-row">
                <label>Giocatori Umani:</label>
                <input type="number" id="input-umani" value="1" min="1" max="6" onchange="checkInputs()">
            </div>
            
            <button class="btn-start" onclick="avviaGioco()">INIZIA PARTITA</button>
        </div>
    </div>

    <div id="tavolo-container">
        <div id="tavolo-gioco">
            
            <div id="area-centrale">
                <div class="slot-centro" id="slot-mazzo">
                    <div class="label-slot">MAZZO</div>
                </div>
                <div class="slot-centro" id="slot-scarti">
                    <div class="label-slot">SCARTI</div>
                </div>
            </div>

            <div id="zona-bussa">
                Tocca 4<br>volte<br>per bussare
            </div>
            <div id="animazione-bussata">ðŸ‘Š</div>

            <div id="tutorial-msg">In attesa...</div>
        </div>
    </div>

    <div id="overlay-fine">
        <div id="overlay-contenuto">
            <h2 id="titolo-fine">VITTORIA!</h2>
            <div id="lista-punteggi" style="margin-bottom: 20px; text-align: left;"></div>
            <button class="btn-start" onclick="location.reload()">Torna alla Home</button>
        </div>
    </div>

<script>
    // --- CONFIGURAZIONE ---
    const semi = ['denari', 'coppe', 'bastoni', 'spade'];
    let numGiocatori = 4;
    let numUmani = 1;
    let giocatori = [];
    let mazzo = [];
    let scarti = [];
    let turnoIndice = 0;
    let faseTurno = 'PESCA'; // PESCA o SCARTO
    let partitaFinita = false;
    let contaBussate = 0;
    let timerBussata;

    // --- SETUP ---
    function checkInputs() {
        let tot = parseInt(document.getElementById('input-totale').value);
        let hum = parseInt(document.getElementById('input-umani').value);
        if(hum > tot) document.getElementById('input-umani').value = tot;
    }

    function avviaGioco() {
        numGiocatori = parseInt(document.getElementById('input-totale').value);
        numUmani = parseInt(document.getElementById('input-umani').value);
        
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('tavolo-container').style.display = 'flex';
        
        // Listener resize
        window.addEventListener('resize', ricalcolaPosizioni);
        
        nuovaMano();
    }

    function nuovaMano() {
        // Init Variabili
        mazzo = creaMazzo();
        scarti = [mazzo.pop()];
        giocatori = [];
        turnoIndice = 0;
        faseTurno = 'PESCA';
        partitaFinita = false;
        contaBussate = 0;

        // Crea Giocatori
        for(let i=0; i<numGiocatori; i++) {
            let tipo = (i < numUmani) ? 'UMANO' : 'BOT';
            giocatori.push({
                id: i,
                tipo: tipo,
                nome: tipo === 'UMANO' ? `Giocatore ${i+1}` : `Bot ${i+1}`,
                mano: [mazzo.pop(), mazzo.pop(), mazzo.pop()],
                punteggio: 0
            });
        }

        creaDOMGiocatori();
        aggiornaGraficaMazzo();
        aggiornaGraficaScarti();
        ricalcolaPosizioni();
        
        gestisciTurno();
    }

    function creaMazzo() {
        let m = [];
        semi.forEach(s => { for(let i=1; i<=10; i++) m.push({seme:s, rank:i, id:Math.random()}); });
        return m.sort(() => Math.random() - 0.5);
    }

    function calcolaPunteggio(mano) {
        let p = {'denari':0,'coppe':0,'bastoni':0,'spade':0};
        mano.forEach(c => {
            let val = (c.rank === 1) ? 11 : (c.rank >= 8 ? 10 : c.rank);
            p[c.seme] += val;
        });
        return Math.max(...Object.values(p));
    }

    // --- MOTORE DI GIOCO ---
    function gestisciTurno() {
        if(partitaFinita) return;

        const g = giocatori[turnoIndice];
        document.querySelectorAll('.giocatore').forEach(e => e.classList.remove('turno-attivo'));
        
        // Evidenzia giocatore corrente
        const divG = document.getElementById(`g-${g.id}`);
        if(divG) divG.classList.add('turno-attivo');

        g.punteggio = calcolaPunteggio(g.mano);
        aggiornaInfoPunteggio(g);

        // Messaggio Tutorial
        const msg = document.getElementById('tutorial-msg');
        if(g.tipo === 'UMANO') {
            msg.innerText = (faseTurno === 'PESCA') 
                ? `${g.nome}: Trascina dal MAZZO o SCARTI` 
                : `${g.nome}: Trascina una carta agli SCARTI`;
                
            // Abilita interazione bussata solo se Umano e fase corretta
            document.getElementById('zona-bussa').style.opacity = '1';
        } else {
            msg.innerText = `${g.nome} sta pensando...`;
            document.getElementById('zona-bussa').style.opacity = '0.3';
            setTimeout(() => botAI(g), 1000);
        }
    }

    function passaTurno() {
        if(partitaFinita) return;
        turnoIndice = (turnoIndice + 1) % numGiocatori;
        faseTurno = 'PESCA';
        gestisciTurno();
    }

    // --- AI BOT ANIMATA ---
    function botAI(bot) {
        if(partitaFinita) return;

        // 1. DECISIONE PESCA
        const topScarto = scarti[scarti.length-1];
        let vuoleScarto = false;
        
        // Logica semplice: se lo scarto migliora il punto, prendilo
        // (Per semplicitÃ  qui facciamo un check basilare sul valore alto)
        let valoreScarto = (topScarto.rank===1 ? 11 : (topScarto.rank>=8 ? 10 : topScarto.rank));
        if(valoreScarto >= 8) vuoleScarto = true;

        if(vuoleScarto) {
            animazionePescaBot(bot, 'SCARTI', () => {
                bot.mano.push(scarti.pop());
                aggiornaGraficaScarti();
                botScarta(bot);
            });
        } else {
            animazionePescaBot(bot, 'MAZZO', () => {
                if(mazzo.length === 0) rimescola();
                bot.mano.push(mazzo.pop());
                aggiornaGraficaMazzo();
                botScarta(bot);
            });
        }
    }

    function botScarta(bot) {
        // 2. DECISIONE SCARTO
        // Trova la carta peggiore per il seme dominante
        let counts = {'denari':0,'coppe':0,'bastoni':0,'spade':0};
        bot.mano.forEach(c => {
            let val = (c.rank===1 ? 11 : (c.rank>=8 ? 10 : c.rank));
            counts[c.seme] += val;
        });
        
        let bestSeme = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        
        // Cerca carta non del seme migliore, o la piÃ¹ bassa
        let idx = 0;
        let minUtilita = 999;
        
        bot.mano.forEach((c, i) => {
            let val = (c.rank===1 ? 11 : (c.rank>=8 ? 10 : c.rank));
            let utilita = (c.seme === bestSeme) ? val + 20 : val; // Pesa di piÃ¹ le carte del seme buono
            if(utilita < minUtilita) {
                minUtilita = utilita;
                idx = i;
            }
        });

        const cartaDaScartare = bot.mano[idx];

        animazioneScartoBot(bot, cartaDaScartare, () => {
            bot.mano.splice(idx, 1);
            scarti.push(cartaDaScartare);
            aggiornaGraficaScarti();
            aggiornaManoGrafica(bot);
            
            // Check Vittoria
            if(calcolaPunteggio(bot.mano) >= 31) {
                terminaPartita(bot.nome + " ha fatto 31!");
            } else {
                passaTurno();
            }
        });
    }

    // --- ANIMAZIONI ---
    function animazionePescaBot(bot, origine, callback) {
        const startEl = document.getElementById(origine === 'MAZZO' ? 'slot-mazzo' : 'slot-scarti');
        const endEl = document.getElementById(`g-${bot.id}`);
        creaCartaVolante(startEl, endEl, null, callback);
    }

    function animazioneScartoBot(bot, cartaDati, callback) {
        const startEl = document.getElementById(`g-${bot.id}`);
        const endEl = document.getElementById('slot-scarti');
        creaCartaVolante(startEl, endEl, cartaDati, callback);
    }

    function creaCartaVolante(startEl, endEl, cartaDati, callback) {
        const rectStart = startEl.getBoundingClientRect();
        const rectEnd = endEl.getBoundingClientRect();

        const fly = document.createElement('div');
        fly.className = 'carta carta-animata';
        
        if(cartaDati) {
             setCartaBackground(fly, cartaDati);
        } else {
             fly.classList.add('carta-retro');
        }

        fly.style.left = rectStart.left + 'px';
        fly.style.top = rectStart.top + 'px';
        fly.style.width = rectStart.width > 60 ? '7.2vmin' : rectStart.width + 'px'; // Adatta size
        fly.style.height = rectStart.height > 90 ? '12vmin' : rectStart.height + 'px';

        document.body.appendChild(fly);

        // Trigger animation
        requestAnimationFrame(() => {
            fly.style.left = (rectEnd.left + rectEnd.width/2 - 30) + 'px'; // Centra approx
            fly.style.top = (rectEnd.top + rectEnd.height/2 - 50) + 'px';
        });

        setTimeout(() => {
            fly.remove();
            if(callback) callback();
        }, 600); // Durata CSS transition
    }


    // --- GESTIONE GRAFICA E DRAG ---
    function creaDOMGiocatori() {
        const tavolo = document.getElementById('tavolo-gioco');
        // Rimuovi vecchi
        document.querySelectorAll('.giocatore').forEach(e => e.remove());

        giocatori.forEach(g => {
            const div = document.createElement('div');
            div.className = 'giocatore';
            div.id = `g-${g.id}`;
            if(g.tipo === 'UMANO') div.classList.add('giocatore-umano');
            
            div.innerHTML = `
                <div class="avatar">${g.nome.charAt(0)}</div>
                <div class="info-box" id="info-${g.id}">Pt: 0</div>
                <div class="area-carte" id="carte-${g.id}"></div>
            `;
            tavolo.appendChild(div);
            aggiornaManoGrafica(g);
        });
    }

    function ricalcolaPosizioni() {
        const tavolo = document.getElementById('tavolo-gioco');
        if(!tavolo) return;
        const w = tavolo.offsetWidth;
        const r = w/2 - (w * 0.12);
        const c = w/2;

        giocatori.forEach((g, i) => {
            const div = document.getElementById(`g-${g.id}`);
            // Ruota in modo che il turno corrente sia sempre in basso (opzionale) 
            // OPPURE: layout fisso. Facciamo layout fisso ma responsive.
            // 0 sempre basso.
            const step = 360 / numGiocatori;
            const deg = 90 + (i * step);
            const rad = deg * (Math.PI/180);
            
            div.style.left = (c + r * Math.cos(rad)) + 'px';
            div.style.top = (c + r * Math.sin(rad)) + 'px';
        });
    }

    function aggiornaManoGrafica(g) {
        const container = document.getElementById(`carte-${g.id}`);
        container.innerHTML = '';
        
        // Mostra carte se Ã¨ UMANO O se la partita Ã¨ finita
        const mostraFaccia = (g.tipo === 'UMANO' || partitaFinita);
        
        g.mano.forEach((c, idx) => {
            const el = document.createElement('div');
            el.className = 'carta';
            if(mostraFaccia) {
                setCartaBackground(el, c);
                // Drag Logic
                if(g.tipo === 'UMANO' && !partitaFinita) {
                    el.dataset.idx = idx;
                    el.dataset.type = 'MANO';
                    setupDrag(el);
                }
            } else {
                el.classList.add('carta-retro');
            }
            container.appendChild(el);
        });
        aggiornaInfoPunteggio(g);
    }

    function setCartaBackground(el, c) {
        const semiMap = {'denari':0,'coppe':1,'bastoni':2,'spade':3};
        // Sprite CSS:
        // X = (rank-1) * 100 / 9 %
        // Y = semiMap * 100 / 3 %
        el.style.backgroundPosition = `${(c.rank-1)*(100/9)}% ${semiMap[c.seme]*(100/3)}%`;
    }

    function aggiornaInfoPunteggio(g) {
        const box = document.getElementById(`info-${g.id}`);
        if(!box) return;
        // Se partita in corso, mostra punti solo a Umani. Se finita, a tutti.
        if(g.tipo === 'UMANO' || partitaFinita) {
            box.innerText = `Pt: ${g.punteggio}`;
        } else {
            box.innerText = `Pt: ?`;
        }
    }

    function aggiornaGraficaScarti() {
        const slot = document.getElementById('slot-scarti');
        const lbl = slot.querySelector('.label-slot'); 
        slot.innerHTML = ''; slot.appendChild(lbl);
        
        if(scarti.length > 0) {
            const c = scarti[scarti.length-1];
            const el = document.createElement('div');
            el.className = 'carta';
            setCartaBackground(el, c);
            el.style.top='50%'; el.style.left='50%'; el.style.transform='translate(-50%,-50%)';
            
            // Abilita Drag
            el.dataset.type = 'SCARTI';
            setupDrag(el);
            slot.appendChild(el);
        }
    }

    function aggiornaGraficaMazzo() {
        const slot = document.getElementById('slot-mazzo');
        const lbl = slot.querySelector('.label-slot');
        slot.innerHTML = ''; slot.appendChild(lbl);
        
        if(mazzo.length > 0) {
            const el = document.createElement('div');
            el.className = 'carta carta-retro';
            el.style.top='50%'; el.style.left='50%'; el.style.transform='translate(-50%,-50%)';
            el.dataset.type = 'MAZZO';
            setupDrag(el);
            slot.appendChild(el);
        } else {
            // Se mazzo vuoto, rimescola
            rimescola();
        }
    }
    
    function rimescola() {
        if(scarti.length <= 1) return; // Non si puÃ² mescolare se non ci sono scarti
        let ultima = scarti.pop();
        mazzo = scarti;
        scarti = [ultima];
        mazzo.sort(() => Math.random() - 0.5);
        aggiornaGraficaMazzo();
        aggiornaGraficaScarti();
    }

    // --- LOGICA DRAG & DROP UNIFICATA ---
    let dragItem = null;
    let dragClone = null;
    let touchStartX, touchStartY;

    function setupDrag(el) {
        el.addEventListener('mousedown', startDrag);
        el.addEventListener('touchstart', startDrag, {passive:false});
    }

    function startDrag(e) {
        if(partitaFinita) return;
        // Verifica se Ã¨ il turno di questo giocatore (se umano)
        const gAttuale = giocatori[turnoIndice];
        if(gAttuale.tipo !== 'UMANO') return;

        // Regole Fase
        const type = e.target.dataset.type;
        if(faseTurno === 'PESCA' && type === 'MANO') return; // Prima pesca!
        if(faseTurno === 'SCARTO' && (type === 'MAZZO' || type === 'SCARTI')) return; // Prima scarta!

        e.preventDefault();
        dragItem = e.target;
        
        // Clone
        const rect = dragItem.getBoundingClientRect();
        dragClone = dragItem.cloneNode(true);
        dragClone.classList.add('carta-dragging');
        dragClone.style.left = rect.left + 'px';
        dragClone.style.top = rect.top + 'px';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.height = rect.height + 'px';
        document.body.appendChild(dragClone);

        const pt = e.touches ? e.touches[0] : e;
        touchStartX = pt.clientX;
        touchStartY = pt.clientY;

        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('touchmove', moveDrag, {passive:false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function moveDrag(e) {
        if(!dragClone) return;
        e.preventDefault();
        const pt = e.touches ? e.touches[0] : e;
        const dx = pt.clientX - touchStartX;
        const dy = pt.clientY - touchStartY;
        
        // Muovi sommando al left/top iniziale
        let curLeft = parseFloat(dragClone.style.left);
        let curTop = parseFloat(dragClone.style.top);
        dragClone.style.left = (curLeft + dx) + 'px';
        dragClone.style.top = (curTop + dy) + 'px';
        
        touchStartX = pt.clientX;
        touchStartY = pt.clientY;
    }

    function endDrag(e) {
        document.removeEventListener('mousemove', moveDrag);
        document.removeEventListener('touchmove', moveDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);

        if(!dragClone) return;

        // Collision Check
        const cRect = dragClone.getBoundingClientRect();
        const cX = cRect.left + cRect.width/2;
        const cY = cRect.top + cRect.height/2;

        const g = giocatori[turnoIndice];
        const zonaMano = document.getElementById(`carte-${g.id}`).getBoundingClientRect();
        const zonaScarti = document.getElementById('slot-scarti').getBoundingClientRect();

        let successo = false;
        const sourceType = dragItem.dataset.type;

        // 1. Pesca (Mazzo/Scarti -> Mano)
        if(faseTurno === 'PESCA' && (sourceType==='MAZZO' || sourceType==='SCARTI')) {
            if(rectHit(cX, cY, zonaMano)) {
                successo = true;
                if(sourceType === 'MAZZO') {
                    if(mazzo.length===0) rimescola();
                    g.mano.push(mazzo.pop());
                    aggiornaGraficaMazzo();
                } else {
                    g.mano.push(scarti.pop());
                    aggiornaGraficaScarti();
                }
                faseTurno = 'SCARTO';
                aggiornaManoGrafica(g);
                gestisciTurno(); // Aggiorna testi
            }
        }
        
        // 2. Scarto (Mano -> Scarti)
        if(faseTurno === 'SCARTO' && sourceType === 'MANO') {
            if(rectHit(cX, cY, zonaScarti)) {
                successo = true;
                const idx = parseInt(dragItem.dataset.idx);
                const carta = g.mano.splice(idx, 1)[0];
                scarti.push(carta);
                aggiornaGraficaScarti();
                aggiornaManoGrafica(g);
                
                // Check 31
                if(calcolaPunteggio(g.mano) >= 31) {
                    terminaPartita(g.nome + " ha fatto 31!");
                } else {
                    passaTurno();
                }
            }
        }

        dragClone.remove();
        dragClone = null;
        dragItem = null;
    }

    function rectHit(x, y, rect) {
        return (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
    }


    // --- BUSSATA & FINE ---
    document.getElementById('zona-bussa').addEventListener('click', handleBussa);
    document.getElementById('zona-bussa').addEventListener('touchstart', (e)=>{e.preventDefault(); handleBussa();});

    function handleBussa() {
        if(partitaFinita) return;
        const g = giocatori[turnoIndice];
        if(g.tipo !== 'UMANO') return;
        // Si puÃ² bussare solo se si Ã¨ pescato e si hanno 4 carte?
        // O se ne hanno 3 prima di pescare? Regola comune: Bussata = Fine turno SENZA scartare o DOPO scarto.
        // Implementazione semplice: Se tocchi 4 volte, chiudi.
        
        contaBussate++;
        clearTimeout(timerBussata);
        timerBussata = setTimeout(()=>contaBussate=0, 800);

        if(contaBussate >= 4) {
            triggerAnimBussa();
            setTimeout(() => {
                terminaPartita(g.nome + " HA BUSSATO!");
            }, 800);
        }
    }

    function triggerAnimBussa() {
        const a = document.getElementById('animazione-bussata');
        a.style.display='block';
        a.style.animation='knockAnim 0.6s ease';
        setTimeout(()=>{a.style.display='none';},600);
    }

    function terminaPartita(motivo) {
        partitaFinita = true;
        
        // Riveliamo tutte le carte
        giocatori.forEach(g => {
            aggiornaManoGrafica(g); // Questo rimuove i retri perchÃ© partitaFinita = true
        });

        // Mostra Overlay con calma
        setTimeout(() => {
            const over = document.getElementById('overlay-fine');
            over.style.display = 'flex';
            document.getElementById('titolo-fine').innerText = motivo;
            
            // Genera classifica
            let classifica = [...giocatori].sort((a,b) => b.punteggio - a.punteggio);
            let html = '';
            classifica.forEach(g => {
                let color = (g.id === classifica[0].id) ? '#ffeb3b' : 'white';
                html += `<div class="risultato-riga" style="color:${color}">
                            <span>${g.nome}</span> <span>${g.punteggio} pt</span>
                         </div>`;
            });
            document.getElementById('lista-punteggi').innerHTML = html;
        }, 1000);
    }

</script>
</body>
</html>