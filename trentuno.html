<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>31 Napoletano - Torneo</title>
    <style>
        /* --- STILE GENERALE --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }

        /* --- LOBBY --- */
        #lobby-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1b5e20, #000);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2000;
        }
        
        .lobby-box {
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px;
            text-align: center; border: 2px solid #ffeb3b; width: 80%; max-width: 400px;
        }

        .lobby-row { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        input[type="number"] { padding: 5px; width: 60px; text-align: center; font-size: 18px; border-radius: 5px; border: none;}
        
        .btn-start {
            padding: 15px 30px; font-size: 20px; background: #ffeb3b; color: #000;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px;
        }

        /* --- TAVOLO --- */
        #tavolo-container {
            position: relative; width: 100vw; height: 100vh;
            display: none; justify-content: center; align-items: center;
        }

        #tavolo-gioco {
            position: relative; width: 95vmin; height: 95vmin;
            background: radial-gradient(circle, #388e3c 0%, #1b5e20 100%);
            border-radius: 50%; border: 4vmin solid #5d4037;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- AREE --- */
        #area-centrale {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 45%; height: 35%;
            display: flex; justify-content: space-around; align-items: center;
            border: 2px dashed rgba(255,255,255,0.1); border-radius: 10px;
        }

        .slot-centro {
            width: 40%; height: 90%;
            background: rgba(0,0,0,0.2); border-radius: 5px; position: relative;
        }
        .label-slot { position: absolute; bottom: -25px; width: 100%; text-align: center; font-size: 12px; color: #aaa; }

        /* --- GIOCATORI --- */
        .giocatore {
            position: absolute; width: 18vmin; height: 18vmin;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.5s ease;
        }
        
        /* Nascondiamo i giocatori eliminati */
        .giocatore.eliminato {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .avatar {
            width: 7vmin; height: 7vmin;
            background: #eee; border: 0.5vmin solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: black; font-weight: bold; font-size: 3vmin; z-index: 2;
            position: relative;
        }

        .vite-container {
            position: absolute; top: -1.5vmin; right: -1vmin;
            background: rgba(0,0,0,0.8); border-radius: 10px;
            padding: 2px 5px; font-size: 1.8vmin; color: red;
            white-space: nowrap; border: 1px solid white;
        }

        .info-box {
            background: rgba(0,0,0,0.7); padding: 2px 8px; border-radius: 10px;
            font-size: 2.5vmin; margin-top: -1vmin; z-index: 3; color: white;
        }

        .turno-attivo .avatar { border-color: #ffeb3b; box-shadow: 0 0 25px #ffeb3b; transform: scale(1.1); }
        .turno-attivo .info-box { color: #ffeb3b; }

        /* --- CARTE --- */
        .area-carte {
            display: flex; justify-content: center; margin-top: 1vmin;
            height: 12vmin; width: 22vmin; position: relative;
        }

        .carta {
            width: 7.2vmin; height: 12vmin;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c4/Carte_napoletane_al_completo.jpg');
            background-size: 72vmin 48vmin; /* 10col * 7.2 = 72 */
            border-radius: 0.5vmin;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            position: absolute; 
            background-color: white;
        }
        
        .carta-retro {
            /* NUOVO RETRO RICHIESTO */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Carte_Napoletane_retro.jpg/960px-Carte_Napoletane_retro.jpg');
            background-size: cover; border: 1px solid #ccc;
        }

        /* Carte Umano */
        .giocatore-umano .area-carte .carta {
            position: relative; margin-left: -3.5vmin; cursor: grab;
            transition: transform 0.2s, margin 0.2s;
        }
        .giocatore-umano .area-carte .carta:first-child { margin-left: 0; }
        .giocatore-umano .area-carte .carta:hover { transform: translateY(-1vmin); z-index: 10; }
        .giocatore-umano .area-carte .carta:active { cursor: grabbing; }

        /* Animazione Volo */
        .carta-animata {
            position: fixed; z-index: 9999; pointer-events: none;
            transition: all 0.8s ease-in-out; /* PiÃ¹ lenta per far capire */
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            transform: scale(1.2);
        }

        .carta-dragging {
            position: fixed !important; z-index: 9999 !important; pointer-events: none;
            transform: scale(1.1) rotate(5deg); opacity: 0.9;
        }

        /* --- BUSSATA & UI --- */
        #zona-bussa {
            position: absolute; right: 10%; bottom: 20%;
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.15);
            border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%;
            cursor: pointer; display: flex; text-align: center;
            justify-content: center; align-items: center; font-size: 11px;
            user-select: none;
        }
        #zona-bussa:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

        #animazione-bussata {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-size: 100px;
            display: none; z-index: 500; pointer-events: none;
        }
        @keyframes knockAnim {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* --- OVERLAY FINE MANO / PARTITA --- */
        #overlay-fine {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 3000;
        }
        #overlay-contenuto {
            background: #222; padding: 30px; border-radius: 10px;
            border: 2px solid #ffeb3b; text-align: center; min-width: 300px; max-width: 90%;
        }
        h2 { color: #ffeb3b; margin: 0 0 10px 0; font-size: 30px;}
        .risultato-riga { 
            display: flex; justify-content: space-between; margin: 8px 0; 
            font-size: 18px; border-bottom: 1px solid #444; padding-bottom: 5px;
        }
        .cuori-display { color: red; margin-left: 10px; }
        
        #tutorial-msg {
            position: absolute; bottom: 5%; width: 100%; text-align: center;
            font-size: 2.5vmin; color: rgba(255,255,255,0.8); pointer-events: none;
            background: rgba(0,0,0,0.5); padding: 5px 0;
        }

        .highlight-slot {
            box-shadow: 0 0 20px 5px #ffeb3b;
            border-color: #ffeb3b;
            transition: 0.3s;
        }

    </style>
</head>
<body>

    <div id="lobby-screen">
        <div class="lobby-box">
            <h1 style="color:#ffeb3b; margin-top:0;">31 Napoletano</h1>
            <p style="font-size: 14px; color: #ccc;">Ogni giocatore ha 3 vite.<br>Chi fa il punteggio piÃ¹ basso perde una vita.</p>
            
            <div class="lobby-row">
                <label>Totale Giocatori (2-6):</label>
                <input type="number" id="input-totale" value="4" min="2" max="6" onchange="checkInputs()">
            </div>
            
            <div class="lobby-row">
                <label>Giocatori Umani:</label>
                <input type="number" id="input-umani" value="1" min="1" max="6" onchange="checkInputs()">
            </div>
            
            <button class="btn-start" onclick="setupIniziale()">INIZIA TORNEO</button>
        </div>
    </div>

    <div id="tavolo-container">
        <div id="tavolo-gioco">
            
            <div id="area-centrale">
                <div class="slot-centro" id="slot-mazzo">
                    <div class="label-slot">MAZZO</div>
                </div>
                <div class="slot-centro" id="slot-scarti">
                    <div class="label-slot">SCARTI</div>
                </div>
            </div>

            <div id="zona-bussa">
                Tocca 4<br>volte<br>per bussare
            </div>
            <div id="animazione-bussata">ðŸ‘Š</div>

            <div id="tutorial-msg">In attesa...</div>
        </div>
    </div>

    <div id="overlay-fine">
        <div id="overlay-contenuto">
            <h2 id="titolo-fine">FINE MANO</h2>
            <div id="lista-punteggi" style="margin-bottom: 20px; text-align: left;"></div>
            
            <button id="btn-next-round" class="btn-start" onclick="nuovaMano()">Prossima Mano</button>
            <button id="btn-home" class="btn-start" onclick="location.reload()" style="display:none; background-color:#f44336; color:white;">Menu Principale</button>
        </div>
    </div>

<script>
    // --- CONFIGURAZIONE ---
    const semi = ['denari', 'coppe', 'bastoni', 'spade'];
    let numGiocatori = 4;
    let numUmani = 1;
    let giocatori = []; // Array persistente per le vite
    let mazzo = [];
    let scarti = [];
    let turnoIndice = 0;
    let dealerIndex = 0; // Chi da le carte ruota
    let faseTurno = 'PESCA'; 
    let manoFinita = false;
    let contaBussate = 0;
    let timerBussata;

    // --- SETUP INIZIALE ---
    function checkInputs() {
        let tot = parseInt(document.getElementById('input-totale').value);
        let hum = parseInt(document.getElementById('input-umani').value);
        if(hum > tot) document.getElementById('input-umani').value = tot;
    }

    function setupIniziale() {
        numGiocatori = parseInt(document.getElementById('input-totale').value);
        numUmani = parseInt(document.getElementById('input-umani').value);
        
        // Creiamo i giocatori con 3 vite
        giocatori = [];
        for(let i=0; i<numGiocatori; i++) {
            let tipo = (i < numUmani) ? 'UMANO' : 'BOT';
            giocatori.push({
                id: i,
                tipo: tipo,
                nome: tipo === 'UMANO' ? `Giocatore ${i+1}` : `Bot ${i+1}`,
                mano: [],
                punteggio: 0,
                vite: 3,
                eliminato: false
            });
        }

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('tavolo-container').style.display = 'flex';
        
        window.addEventListener('resize', ricalcolaPosizioni);
        
        // Inizia la prima mano
        dealerIndex = Math.floor(Math.random() * numGiocatori);
        nuovaMano();
    }

    // --- LOGICA NUOVA MANO ---
    function nuovaMano() {
        document.getElementById('overlay-fine').style.display = 'none';
        
        // Reset variabili mano
        mazzo = creaMazzo();
        scarti = [mazzo.pop()];
        manoFinita = false;
        contaBussate = 0;
        
        // Distribuzione carte (solo ai vivi)
        giocatori.forEach(g => {
            g.mano = [];
            g.punteggio = 0;
            if(!g.eliminato) {
                g.mano.push(mazzo.pop());
                g.mano.push(mazzo.pop());
                g.mano.push(mazzo.pop());
            }
        });

        // Il turno inizia dopo il dealer, saltando i morti
        turnoIndice = dealerIndex;
        passaTurno(true); // true = non scartare, solo cambio indice

        creaDOMGiocatori();
        aggiornaGraficaMazzo();
        aggiornaGraficaScarti();
        ricalcolaPosizioni();
        
        // Avvia il ciclo
        gestisciTurno();
    }

    function creaMazzo() {
        let m = [];
        semi.forEach(s => { for(let i=1; i<=10; i++) m.push({seme:s, rank:i, id:Math.random()}); });
        return m.sort(() => Math.random() - 0.5);
    }

    function calcolaPunteggio(mano) {
        if(!mano || mano.length === 0) return 0;
        let p = {'denari':0,'coppe':0,'bastoni':0,'spade':0};
        mano.forEach(c => {
            let val = (c.rank === 1) ? 11 : (c.rank >= 8 ? 10 : c.rank);
            p[c.seme] += val;
        });
        return Math.max(...Object.values(p));
    }

    // --- MOTORE DI GIOCO ---
    function gestisciTurno() {
        if(manoFinita) return;

        const g = giocatori[turnoIndice];

        // Se per qualche motivo tocca a un morto, passiamo
        if(g.eliminato) {
            passaTurno();
            return;
        }

        document.querySelectorAll('.giocatore').forEach(e => e.classList.remove('turno-attivo'));
        
        const divG = document.getElementById(`g-${g.id}`);
        if(divG) divG.classList.add('turno-attivo');

        g.punteggio = calcolaPunteggio(g.mano);
        aggiornaInfoPunteggio(g);

        // Messaggi
        const msg = document.getElementById('tutorial-msg');
        if(g.tipo === 'UMANO') {
            msg.innerText = (faseTurno === 'PESCA') 
                ? `${g.nome}: Tocca a te! Trascina dal MAZZO o SCARTI` 
                : `${g.nome}: Scarta una carta`;
            document.getElementById('zona-bussa').style.opacity = '1';
        } else {
            msg.innerText = `${g.nome} sta giocando...`;
            document.getElementById('zona-bussa').style.opacity = '0.3';
            setTimeout(() => botAI(g), 1200); // Pausa per realismo
        }
    }

    function passaTurno(isSetup = false) {
        if(manoFinita && !isSetup) return;
        
        let tentativi = 0;
        do {
            turnoIndice = (turnoIndice + 1) % numGiocatori;
            tentativi++;
        } while(giocatori[turnoIndice].eliminato && tentativi < numGiocatori * 2);

        faseTurno = 'PESCA';
        if(!isSetup) gestisciTurno();
    }

    // --- AI BOT MIGLIORATA ---
    function botAI(bot) {
        if(manoFinita) return;

        const topScarto = scarti[scarti.length-1];
        let vuoleScarto = false;
        
        // Logica semplice: se lo scarto Ã¨ una figura/asso e migliora il seme, prendilo
        let valoreScarto = (topScarto.rank===1 ? 11 : (topScarto.rank>=8 ? 10 : topScarto.rank));
        if(valoreScarto >= 8) vuoleScarto = true;

        if(vuoleScarto) {
            // Animazione da TERRA a BOT
            animazionePescaBot(bot, 'SCARTI', () => {
                bot.mano.push(scarti.pop());
                aggiornaGraficaScarti();
                botScarta(bot);
            });
        } else {
            // Animazione da MAZZO a BOT
            animazionePescaBot(bot, 'MAZZO', () => {
                if(mazzo.length === 0) rimescola();
                bot.mano.push(mazzo.pop());
                aggiornaGraficaMazzo();
                botScarta(bot);
            });
        }
    }

    function botScarta(bot) {
        // Pausa "pensiero" dopo aver pescato
        setTimeout(() => {
            // Trova carta peggiore
            let counts = {'denari':0,'coppe':0,'bastoni':0,'spade':0};
            bot.mano.forEach(c => {
                let val = (c.rank===1 ? 11 : (c.rank>=8 ? 10 : c.rank));
                counts[c.seme] += val;
            });
            let bestSeme = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            
            let idx = 0;
            let minUtilita = 999;
            bot.mano.forEach((c, i) => {
                let val = (c.rank===1 ? 11 : (c.rank>=8 ? 10 : c.rank));
                let utilita = (c.seme === bestSeme) ? val + 20 : val;
                if(utilita < minUtilita) { minUtilita = utilita; idx = i; }
            });

            const cartaDaScartare = bot.mano[idx];

            animazioneScartoBot(bot, cartaDaScartare, () => {
                bot.mano.splice(idx, 1);
                scarti.push(cartaDaScartare);
                aggiornaGraficaScarti();
                aggiornaManoGrafica(bot);
                
                if(calcolaPunteggio(bot.mano) >= 31) {
                    terminaMano(bot.nome + " ha fatto 31!");
                } else {
                    passaTurno();
                }
            });
        }, 800);
    }

    // --- ANIMAZIONI VISIVE ---
    function animazionePescaBot(bot, origine, callback) {
        const slotID = origine === 'MAZZO' ? 'slot-mazzo' : 'slot-scarti';
        const startEl = document.getElementById(slotID);
        const endEl = document.getElementById(`g-${bot.id}`);

        // Evidenzia lo slot per far capire da dove pesca
        startEl.classList.add('highlight-slot');
        setTimeout(() => startEl.classList.remove('highlight-slot'), 500);

        // Se pesca da scarti, usiamo la carta visibile, altrimenti retro
        let cartaVisual = null;
        if(origine === 'SCARTI') cartaVisual = scarti[scarti.length-1];

        creaCartaVolante(startEl, endEl, cartaVisual, callback);
    }

    function animazioneScartoBot(bot, cartaDati, callback) {
        const startEl = document.getElementById(`g-${bot.id}`);
        const endEl = document.getElementById('slot-scarti');
        creaCartaVolante(startEl, endEl, cartaDati, callback);
    }

    function creaCartaVolante(startEl, endEl, cartaDati, callback) {
        const rectStart = startEl.getBoundingClientRect();
        const rectEnd = endEl.getBoundingClientRect();

        const fly = document.createElement('div');
        fly.className = 'carta carta-animata';
        
        if(cartaDati) {
             setCartaBackground(fly, cartaDati);
        } else {
             fly.classList.add('carta-retro');
        }

        // Posizione di partenza
        fly.style.left = rectStart.left + 'px';
        fly.style.top = rectStart.top + 'px';
        fly.style.width = rectStart.width > 60 ? '7.2vmin' : rectStart.width + 'px';
        fly.style.height = rectStart.height > 90 ? '12vmin' : rectStart.height + 'px';

        document.body.appendChild(fly);

        // Trigger movimento
        requestAnimationFrame(() => {
            fly.style.left = (rectEnd.left + rectEnd.width/2 - 30) + 'px';
            fly.style.top = (rectEnd.top + rectEnd.height/2 - 50) + 'px';
        });

        setTimeout(() => {
            fly.remove();
            if(callback) callback();
        }, 800); // Sincronizzato con CSS transition
    }

    // --- GESTIONE GRAFICA E DRAG ---
    function creaDOMGiocatori() {
        const tavolo = document.getElementById('tavolo-gioco');
        // Rimuoviamo SOLO gli elementi giocatore, non il centro o bussa
        tavolo.querySelectorAll('.giocatore').forEach(e => e.remove());

        giocatori.forEach(g => {
            const div = document.createElement('div');
            div.className = 'giocatore';
            div.id = `g-${g.id}`;
            if(g.tipo === 'UMANO') div.classList.add('giocatore-umano');
            if(g.eliminato) div.classList.add('eliminato');
            
            // Genera stringa cuori
            let cuori = '';
            for(let k=0; k<g.vite; k++) cuori += 'â¤ï¸';

            div.innerHTML = `
                <div class="avatar">
                    ${g.nome.charAt(0)}
                    <div class="vite-container">${cuori}</div>
                </div>
                <div class="info-box" id="info-${g.id}">Pt: 0</div>
                <div class="area-carte" id="carte-${g.id}"></div>
            `;
            tavolo.appendChild(div);
            aggiornaManoGrafica(g);
        });
    }

    function ricalcolaPosizioni() {
        const tavolo = document.getElementById('tavolo-gioco');
        if(!tavolo) return;
        const w = tavolo.offsetWidth;
        const r = w/2 - (w * 0.12);
        const c = w/2;

        giocatori.forEach((g, i) => {
            const div = document.getElementById(`g-${g.id}`);
            const step = 360 / numGiocatori;
            const deg = 90 + (i * step);
            const rad = deg * (Math.PI/180);
            
            div.style.left = (c + r * Math.cos(rad)) + 'px';
            div.style.top = (c + r * Math.sin(rad)) + 'px';
        });
    }

    function aggiornaManoGrafica(g) {
        if(g.eliminato) return;
        const container = document.getElementById(`carte-${g.id}`);
        container.innerHTML = '';
        
        const mostraFaccia = (g.tipo === 'UMANO' || manoFinita);
        
        g.mano.forEach((c, idx) => {
            const el = document.createElement('div');
            el.className = 'carta';
            if(mostraFaccia) {
                setCartaBackground(el, c);
                if(g.tipo === 'UMANO' && !manoFinita) {
                    el.dataset.idx = idx;
                    el.dataset.type = 'MANO';
                    setupDrag(el);
                }
            } else {
                el.classList.add('carta-retro');
            }
            container.appendChild(el);
        });
        aggiornaInfoPunteggio(g);
    }

    function setCartaBackground(el, c) {
        const semiMap = {'denari':0,'coppe':1,'bastoni':2,'spade':3};
        el.style.backgroundPosition = `${(c.rank-1)*(100/9)}% ${semiMap[c.seme]*(100/3)}%`;
    }

    function aggiornaInfoPunteggio(g) {
        const box = document.getElementById(`info-${g.id}`);
        if(!box) return;
        if(g.eliminato) { box.innerText = "OUT"; return; }
        
        if(g.tipo === 'UMANO' || manoFinita) {
            box.innerText = `Pt: ${g.punteggio}`;
        } else {
            box.innerText = `Pt: ?`;
        }
    }

    function aggiornaGraficaScarti() {
        const slot = document.getElementById('slot-scarti');
        const lbl = slot.querySelector('.label-slot'); 
        slot.innerHTML = ''; slot.appendChild(lbl);
        
        if(scarti.length > 0) {
            const c = scarti[scarti.length-1];
            const el = document.createElement('div');
            el.className = 'carta';
            setCartaBackground(el, c);
            el.style.top='50%'; el.style.left='50%'; el.style.transform='translate(-50%,-50%)';
            el.dataset.type = 'SCARTI';
            setupDrag(el);
            slot.appendChild(el);
        }
    }

    function aggiornaGraficaMazzo() {
        const slot = document.getElementById('slot-mazzo');
        const lbl = slot.querySelector('.label-slot');
        slot.innerHTML = ''; slot.appendChild(lbl);
        
        if(mazzo.length > 0) {
            const el = document.createElement('div');
            el.className = 'carta carta-retro';
            el.style.top='50%'; el.style.left='50%'; el.style.transform='translate(-50%,-50%)';
            el.dataset.type = 'MAZZO';
            setupDrag(el);
            slot.appendChild(el);
        } else { rimescola(); }
    }
    
    function rimescola() {
        if(scarti.length <= 1) return;
        let ultima = scarti.pop();
        mazzo = scarti;
        scarti = [ultima];
        mazzo.sort(() => Math.random() - 0.5);
        aggiornaGraficaMazzo();
        aggiornaGraficaScarti();
    }

    // --- DRAG & DROP ---
    let dragItem = null;
    let dragClone = null;
    let touchStartX, touchStartY;

    function setupDrag(el) {
        el.addEventListener('mousedown', startDrag);
        el.addEventListener('touchstart', startDrag, {passive:false});
    }

    function startDrag(e) {
        if(manoFinita) return;
        const gAttuale = giocatori[turnoIndice];
        if(gAttuale.tipo !== 'UMANO' || gAttuale.id !== 0) return; // Solo player 0 Ã¨ 'te' per il drag

        const type = e.target.dataset.type;
        if(faseTurno === 'PESCA' && type === 'MANO') return;
        if(faseTurno === 'SCARTO' && (type === 'MAZZO' || type === 'SCARTI')) return;

        e.preventDefault();
        dragItem = e.target;
        
        const rect = dragItem.getBoundingClientRect();
        dragClone = dragItem.cloneNode(true);
        dragClone.classList.add('carta-dragging');
        dragClone.style.left = rect.left + 'px';
        dragClone.style.top = rect.top + 'px';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.height = rect.height + 'px';
        document.body.appendChild(dragClone);

        const pt = e.touches ? e.touches[0] : e;
        touchStartX = pt.clientX;
        touchStartY = pt.clientY;

        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('touchmove', moveDrag, {passive:false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function moveDrag(e) {
        if(!dragClone) return;
        e.preventDefault();
        const pt = e.touches ? e.touches[0] : e;
        const dx = pt.clientX - touchStartX;
        const dy = pt.clientY - touchStartY;
        
        let curLeft = parseFloat(dragClone.style.left);
        let curTop = parseFloat(dragClone.style.top);
        dragClone.style.left = (curLeft + dx) + 'px';
        dragClone.style.top = (curTop + dy) + 'px';
        
        touchStartX = pt.clientX;
        touchStartY = pt.clientY;
    }

    function endDrag(e) {
        document.removeEventListener('mousemove', moveDrag);
        document.removeEventListener('touchmove', moveDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);

        if(!dragClone) return;

        const cRect = dragClone.getBoundingClientRect();
        const cX = cRect.left + cRect.width/2;
        const cY = cRect.top + cRect.height/2;

        const g = giocatori[turnoIndice];
        const zonaMano = document.getElementById(`carte-${g.id}`).getBoundingClientRect();
        const zonaScarti = document.getElementById('slot-scarti').getBoundingClientRect();

        let successo = false;
        const sourceType = dragItem.dataset.type;

        if(faseTurno === 'PESCA' && (sourceType==='MAZZO' || sourceType==='SCARTI')) {
            if(rectHit(cX, cY, zonaMano)) {
                successo = true;
                if(sourceType === 'MAZZO') {
                    if(mazzo.length===0) rimescola();
                    g.mano.push(mazzo.pop());
                    aggiornaGraficaMazzo();
                } else {
                    g.mano.push(scarti.pop());
                    aggiornaGraficaScarti();
                }
                faseTurno = 'SCARTO';
                aggiornaManoGrafica(g);
                gestisciTurno();
            }
        }
        
        if(faseTurno === 'SCARTO' && sourceType === 'MANO') {
            if(rectHit(cX, cY, zonaScarti)) {
                successo = true;
                const idx = parseInt(dragItem.dataset.idx);
                const carta = g.mano.splice(idx, 1)[0];
                scarti.push(carta);
                aggiornaGraficaScarti();
                aggiornaManoGrafica(g);
                
                if(calcolaPunteggio(g.mano) >= 31) {
                    terminaMano(g.nome + " ha fatto 31!");
                } else {
                    passaTurno();
                }
            }
        }

        dragClone.remove();
        dragClone = null;
        dragItem = null;
    }

    function rectHit(x, y, rect) {
        return (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
    }

    // --- BUSSATA & FINE ---
    document.getElementById('zona-bussa').addEventListener('click', handleBussa);
    document.getElementById('zona-bussa').addEventListener('touchstart', (e)=>{e.preventDefault(); handleBussa();});

    function handleBussa() {
        if(manoFinita) return;
        const g = giocatori[turnoIndice];
        if(g.tipo !== 'UMANO') return;
        
        contaBussate++;
        clearTimeout(timerBussata);
        timerBussata = setTimeout(()=>contaBussate=0, 800);

        if(contaBussate >= 4) {
            triggerAnimBussa();
            setTimeout(() => {
                terminaMano(g.nome + " HA BUSSATO!");
            }, 800);
        }
    }

    function triggerAnimBussa() {
        const a = document.getElementById('animazione-bussata');
        a.style.display='block';
        a.style.animation='knockAnim 0.6s ease';
        setTimeout(()=>{a.style.display='none';},600);
    }

    function terminaMano(motivo) {
        manoFinita = true;
        
        // Rivela carte
        giocatori.forEach(g => { if(!g.eliminato) aggiornaManoGrafica(g); });

        // Calcola punteggi e perdenti
        // Nota: Solo i giocatori NON eliminati partecipano
        let attivi = giocatori.filter(g => !g.eliminato);
        
        // Trova punteggio minimo
        let minScore = 999;
        attivi.forEach(g => { if(g.punteggio < minScore) minScore = g.punteggio; });

        // Togli vita a chi ha il minimo
        attivi.forEach(g => {
            if(g.punteggio === minScore) {
                g.vite--;
                if(g.vite <= 0) g.eliminato = true;
            }
        });

        setTimeout(() => {
            const over = document.getElementById('overlay-fine');
            over.style.display = 'flex';
            document.getElementById('titolo-fine').innerText = motivo;
            
            let html = '';
            giocatori.forEach(g => {
                let status = g.eliminato ? '(ELIMINATO)' : '';
                let color = g.eliminato ? 'gray' : (g.vite===0 ? 'red' : 'white');
                let cuori = '';
                for(let k=0; k<g.vite; k++) cuori += 'â¤ï¸';
                
                html += `<div class="risultato-riga" style="color:${color}">
                            <span>${g.nome} ${status}</span> 
                            <span>${g.punteggio} pt <span class="cuori-display">${cuori}</span></span>
                         </div>`;
            });
            document.getElementById('lista-punteggi').innerHTML = html;

            // Logica Bottoni
            const btnNext = document.getElementById('btn-next-round');
            const btnHome = document.getElementById('btn-home');
            
            // Conta vivi
            let vivi = giocatori.filter(g => !g.eliminato);
            
            // Se l'umano principale (g[0]) Ã¨ morto: GAME OVER
            if(giocatori[0].eliminato) {
                document.getElementById('titolo-fine').innerText = "GAME OVER";
                btnNext.style.display = 'none';
                btnHome.style.display = 'inline-block';
            } 
            // Se c'Ã¨ solo un vincitore
            else if(vivi.length === 1) {
                document.getElementById('titolo-fine').innerText = `VINCE ${vivi[0].nome}!`;
                btnNext.style.display = 'none';
                btnHome.style.display = 'inline-block';
            }
            // Altrimenti continua
            else {
                btnNext.style.display = 'inline-block';
                btnHome.style.display = 'none';
                // Dealer ruota per la prossima mano
                dealerIndex = (dealerIndex + 1) % numGiocatori;
            }

        }, 1500);
    }

</script>
</body>
</html>