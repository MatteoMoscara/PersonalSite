<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gioco 31 - Drag & Drop</title>
    <style>
        /* --- RESET E BASE --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            overflow: hidden;
            touch-action: none; /* Impedisce lo scroll su mobile durante il gioco */
        }

        /* --- SCHERMATA LOBBY (SETUP) --- */
        #lobby-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1b5e20, #000);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .lobby-box {
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffeb3b;
        }

        input[type="number"] {
            padding: 10px; font-size: 20px; width: 60px; text-align: center; margin: 10px;
        }

        .btn-start {
            padding: 15px 30px; font-size: 20px; background: #ffeb3b; color: #000;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* --- TAVOLO DI GIOCO RESPONSIVE --- */
        #tavolo-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none; /* Nascosto finchÃ© non inizia il gioco */
        }

        #tavolo-gioco {
            position: relative;
            /* Il tavolo Ã¨ quadrato e occupa il 95% del lato piÃ¹ corto dello schermo */
            width: 95vmin; 
            height: 95vmin;
            background: radial-gradient(circle, #388e3c 0%, #1b5e20 100%);
            border-radius: 50%;
            border: 4vmin solid #5d4037;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- ZONA CENTRALE (Mazzo e Scarti) --- */
        #area-centrale {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 35%; height: 25%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .slot-centro {
            width: 40%; height: 90%;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            position: relative;
        }

        .label-slot {
            position: absolute; bottom: -20px; width: 100%; text-align: center; font-size: 2vmin; color: #aaa;
        }

        /* --- ZONA BUSSATA --- */
        #zona-bussa {
            position: absolute;
            right: 15%;
            bottom: 25%;
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            text-align: center;
            user-select: none;
            transition: background 0.1s;
        }
        #zona-bussa:active { background: rgba(255,255,255,0.5); }

        #animazione-bussata {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            display: none;
            z-index: 200;
            pointer-events: none;
        }
        @keyframes knockAnim {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.5) rotate(-10deg); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* --- GIOCATORI --- */
        .giocatore {
            position: absolute;
            width: 15vmin; height: 15vmin;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
            transition: top 0.5s, left 0.5s; /* Transizione fluida quando ruota lo schermo */
        }

        .avatar {
            width: 6vmin; height: 6vmin;
            background: #eee; border: 0.5vmin solid #333;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: black; font-weight: bold; font-size: 2.5vmin;
            background-size: cover;
        }

        .info-box {
            background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 10px;
            font-size: 2vmin; margin-top: -1vmin; z-index: 2;
        }

        .turno-attivo .avatar { border-color: #ffeb3b; box-shadow: 0 0 20px #ffeb3b; }

        /* --- CARTE --- */
        .area-carte {
            display: flex; justify-content: center;
            margin-top: 1vmin;
            height: 12vmin; width: 20vmin;
            position: relative;
        }

        /* La carta base */
        .carta {
            width: 6.75vmin;  /* Proporzione ~ 225px */
            height: 11.25vmin; /* Proporzione ~ 375px */
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c4/Carte_napoletane_al_completo.jpg');
            background-size: 67.5vmin 45vmin; /* 10col x 4righe */
            border-radius: 0.5vmin;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            position: absolute; /* Necessario per sovrapposizione e drag */
            transition: transform 0.2s; /* Solo per hover, NON per drag */
        }

        .carta-retro {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Card_back_01.svg/300px-Card_back_01.svg.png');
            background-size: cover;
            border: 1px solid #ccc;
        }

        /* Per le carte in mano all'umano (posizionamento statico per flexbox all'inizio, poi absolute per drag) */
        .giocatore-umano .area-carte .carta {
            position: relative; 
            margin-left: -3vmin;
            cursor: grab;
        }
        .giocatore-umano .area-carte .carta:first-child { margin-left: 0; }
        .giocatore-umano .area-carte .carta:active { cursor: grabbing; transform: scale(1.1); z-index: 1000; }

        /* Carta trascinata (classe aggiunta via JS) */
        .carta-dragging {
            position: fixed !important;
            z-index: 9999 !important;
            pointer-events: none; /* Lascia passare gli eventi per capire cosa c'Ã¨ sotto */
            transform: scale(1.2) rotate(5deg);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        /* --- OVERLAY MESSAGGI --- */
        #overlay-msg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 2000;
        }
        #msg-text { font-size: 8vmin; color: #ffeb3b; text-align: center; }

        /* Istruzioni volanti */
        #tutorial {
            position: absolute; bottom: 10%; width: 100%; text-align: center;
            font-size: 2.5vmin; color: rgba(255,255,255,0.7); pointer-events: none;
        }

    </style>
</head>
<body>

    <div id="lobby-screen">
        <div class="lobby-box">
            <h1 style="color:#ffeb3b">Ramino / 31 Napoletano</h1>
            <p>Seleziona numero giocatori (2-6)</p>
            <input type="number" id="input-giocatori" value="4" min="2" max="6">
            <br><br>
            <button class="btn-start" onclick="avviaGioco()">INIZIA PARTITA</button>
        </div>
    </div>

    <div id="tavolo-container">
        <div id="tavolo-gioco">
            
            <div id="area-centrale">
                <div class="slot-centro" id="slot-mazzo">
                    <div class="label-slot">MAZZO</div>
                    </div>
                <div class="slot-centro" id="slot-scarti">
                    <div class="label-slot">SCARTI</div>
                    </div>
            </div>

            <div id="zona-bussa">
                Tocca 4 volte<br>per bussare
            </div>
            <div id="animazione-bussata">ðŸ‘Š</div>

            <div id="tutorial">Trascina dal Mazzo/Scarti per pescare.<br>Trascina nel pozzo per scartare.</div>

            </div>
    </div>

    <div id="overlay-msg">
        <div id="msg-text"></div>
        <button class="btn-start" onclick="location.reload()" style="margin-top:20px;">Menu Principale</button>
    </div>

<script>
    // --- VARIABILI GLOBALI ---
    const semi = ['denari', 'coppe', 'bastoni', 'spade'];
    let numGiocatori = 4;
    let mazzo = [];
    let scarti = [];
    let giocatori = [];
    let turnoIndice = 0;
    let faseTurno = 'PESCA'; // PESCA, SCARTO, FINE
    let contaBussate = 0;
    let timerBussata;

    // --- CLASSE CARTA ---
    class Carta {
        constructor(seme, rank) {
            this.seme = seme;
            this.rank = rank; // 1-10
            this.id = Math.random().toString(36).substr(2, 9);
        }
        getPunti() {
            if (this.rank === 1) return 11;
            if (this.rank >= 8) return 10;
            return this.rank;
        }
    }

    // --- SETUP GIOCO ---
    function avviaGioco() {
        const input = document.getElementById('input-giocatori').value;
        numGiocatori = Math.min(Math.max(parseInt(input), 2), 6);
        
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('tavolo-container').style.display = 'flex';

        inizializzaPartita();
        
        // Listener per resize finestra (aggiorna posizioni)
        window.addEventListener('resize', posizionaGiocatori);
    }

    function inizializzaPartita() {
        mazzo = creaMazzo();
        scarti = [mazzo.pop()]; // Una carta scoperta
        giocatori = [];

        // Creazione Giocatori
        for(let i=0; i<numGiocatori; i++) {
            giocatori.push({
                id: i,
                tipo: i===0 ? 'UMANO' : 'BOT',
                nome: i===0 ? 'TU' : `Bot ${i}`,
                mano: [mazzo.pop(), mazzo.pop(), mazzo.pop()],
                punteggio: 0
            });
        }

        // Renderizza Layout Iniziale
        creaElementiGiocatori();
        aggiornaGraficaScarti();
        aggiornaGraficaMazzo();
        posizionaGiocatori(); // Calcolo cerchio
        
        gestisciTurno();
        
        // Setup Bussata
        setupBussata();
    }

    function creaMazzo() {
        let m = [];
        semi.forEach(s => {
            for(let i=1; i<=10; i++) m.push(new Carta(s, i));
        });
        return m.sort(() => Math.random() - 0.5);
    }

    // --- LOGICA GIOCO ---
    function gestisciTurno() {
        const g = giocatori[turnoIndice];
        document.querySelectorAll('.giocatore').forEach(el => el.classList.remove('turno-attivo'));
        
        const divGiocatore = document.getElementById(`giocatore-${g.id}`);
        if(divGiocatore) divGiocatore.classList.add('turno-attivo');

        g.punteggio = calcolaPunteggio(g.mano);
        aggiornaUIBot(g);

        if(g.tipo === 'BOT') {
            setTimeout(() => botGioca(g), 1500);
        } else {
            // Tocca all'umano: i controlli Drag&Drop si attivano automaticamente in base alla fase
            abilitareDrag(true);
        }
    }

    function passaTurno() {
        turnoIndice = (turnoIndice + 1) % numGiocatori;
        faseTurno = 'PESCA';
        gestisciTurno();
    }

    function calcolaPunteggio(mano) {
        let pSemi = { 'denari':0, 'coppe':0, 'bastoni':0, 'spade':0 };
        mano.forEach(c => pSemi[c.seme] += c.getPunti());
        let max = 0;
        for(let s in pSemi) if(pSemi[s] > max) max = pSemi[s];
        return max;
    }

    // --- BOT AI ---
    function botGioca(bot) {
        // 1. Pesca
        const topScarto = scarti[scarti.length-1];
        // Semplice AI: se scarto mi aumenta il punto, lo prendo.
        // Simulazione
        let prendeScarti = false;
        if(topScarto) {
             let manoTest = [...bot.mano, topScarto];
             // Logica semplificata: se Ã¨ dello stesso seme delle mie carte forti
             if(topScarto.getPunti() >= 8) prendeScarti = true; 
        }

        if(prendeScarti) {
            bot.mano.push(scarti.pop());
            aggiornaGraficaScarti();
        } else {
            if(mazzo.length === 0) rimescolaMazzo();
            bot.mano.push(mazzo.pop());
            aggiornaGraficaMazzo();
        }

        // 2. Scarta
        // Trova la carta che non c'entra col seme dominante
        let pSemi = { 'denari':0, 'coppe':0, 'bastoni':0, 'spade':0 };
        bot.mano.forEach(c => pSemi[c.seme] += c.getPunti());
        let semeMigliore = Object.keys(pSemi).reduce((a, b) => pSemi[a] > pSemi[b] ? a : b);
        
        // Scarta la carta peggiore che non Ã¨ del seme migliore (o la piÃ¹ bassa del seme migliore)
        let idxScarto = 0;
        let minVal = 99;
        
        bot.mano.forEach((c, i) => {
            let valoreRelativo = c.getPunti();
            if(c.seme !== semeMigliore) valoreRelativo = 0; // PrioritÃ  scartare altri semi
            if(valoreRelativo < minVal) {
                minVal = valoreRelativo;
                idxScarto = i;
            }
        });

        const cartaScartata = bot.mano.splice(idxScarto, 1)[0];
        scarti.push(cartaScartata);
        aggiornaGraficaScarti();
        aggiornaUIBot(bot);

        // Controllo Bussata
        if(calcolaPunteggio(bot.mano) >= 31) { // Bussata aggressiva solo se 31 pieno o molto alto
            chiudiPartita(bot.nome + " ha fatto 31!");
        } else {
            passaTurno();
        }
    }

    // --- RENDERING GRAFICO ---
    function creaElementiGiocatori() {
        const tavolo = document.getElementById('tavolo-gioco');
        // Rimuovi vecchi
        document.querySelectorAll('.giocatore').forEach(e => e.remove());

        giocatori.forEach(g => {
            const div = document.createElement('div');
            div.className = 'giocatore';
            div.id = `giocatore-${g.id}`;
            if(g.tipo === 'UMANO') div.classList.add('giocatore-umano');

            div.innerHTML = `
                <div class="avatar">${g.nome.charAt(0)}</div>
                <div class="info-box">Pt: ${g.punteggio}</div>
                <div class="area-carte" id="carte-g${g.id}"></div>
            `;
            tavolo.appendChild(div);
            aggiornaManoUI(g);
        });
    }

    function posizionaGiocatori() {
        const tavoloW = document.getElementById('tavolo-gioco').offsetWidth;
        const raggio = tavoloW / 2 - (tavoloW * 0.12); // Margine dal bordo
        const centro = tavoloW / 2;

        giocatori.forEach((g, index) => {
            const div = document.getElementById(`giocatore-${g.id}`);
            // Umano (0) sempre in basso (90 gradi)
            // Gli altri distribuiti equamente
            const step = 360 / numGiocatori;
            const angoloDeg = 90 + (index * step); 
            const rad = angoloDeg * (Math.PI / 180);

            const x = centro + raggio * Math.cos(rad);
            const y = centro + raggio * Math.sin(rad);

            div.style.left = x + 'px';
            div.style.top = y + 'px';
        });
    }

    function aggiornaManoUI(g) {
        const container = document.getElementById(`carte-g${g.id}`);
        container.innerHTML = '';
        
        g.mano.forEach((c, i) => {
            const el = document.createElement('div');
            el.className = 'carta';
            
            if(g.tipo === 'UMANO' || partitaFinita) {
                // Calcola sprite
                const semiMap = { 'denari':0, 'coppe':1, 'bastoni':2, 'spade':3 };
                // Sprite Size: Width=67.5vmin, Height=45vmin
                // Single Card: W=6.75vmin, H=11.25vmin
                const xPos = (c.rank - 1) * 100 / 9; // Percentuale posizione X
                const yPos = semiMap[c.seme] * 100 / 3; // Percentuale posizione Y
                
                // Conversione in background-position percentuale Ã¨ tricky con sprite.
                // Usiamo il calcolo pixels relativo alla dimensione impostata nel CSS
                // Ma per semplicitÃ  responsive, usiamo style inline con calc se possibile o classi
                // Approccio piÃ¹ stabile responsive: background position in %
                // X: 0% (Asso) -> 100% (Re)
                // Y: 0% (Denari) -> 100% (Spade)
                el.style.backgroundPosition = `${(c.rank-1) * (100/9)}% ${semiMap[c.seme] * (100/3)}%`;
                
                // Aggiungi eventi Drag SOLO se Ã¨ umano e non finita
                if(g.tipo === 'UMANO' && !partitaFinita) {
                    el.dataset.index = i; // Salviamo indice array
                    setupDraggable(el, 'MANO');
                }
            } else {
                el.classList.add('carta-retro');
            }
            container.appendChild(el);
        });
        
        // Aggiorna punteggio testo
        const info = document.getElementById(`giocatore-${g.id}`).querySelector('.info-box');
        if(info) info.innerText = (g.tipo === 'UMANO' || partitaFinita) ? `Pt: ${calcolaPunteggio(g.mano)}` : `Pt: ?`;
    }

    function aggiornaUIBot(bot) {
        aggiornaManoUI(bot);
    }

    function aggiornaGraficaScarti() {
        const slot = document.getElementById('slot-scarti');
        // Mantieni la label
        const label = slot.querySelector('.label-slot');
        slot.innerHTML = '';
        slot.appendChild(label);

        if(scarti.length > 0) {
            const c = scarti[scarti.length-1];
            const el = document.createElement('div');
            el.className = 'carta';
            const semiMap = { 'denari':0, 'coppe':1, 'bastoni':2, 'spade':3 };
            el.style.backgroundPosition = `${(c.rank-1) * (100/9)}% ${semiMap[c.seme] * (100/3)}%`;
            el.style.top = '50%'; el.style.left = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            
            // Abilita drag dagli scarti
            setupDraggable(el, 'SCARTI');
            
            slot.appendChild(el);
        }
    }

    function aggiornaGraficaMazzo() {
        const slot = document.getElementById('slot-mazzo');
        // Pulisce e ricrea carta retro
        const label = slot.querySelector('.label-slot');
        slot.innerHTML = '';
        slot.appendChild(label);
        
        if(mazzo.length > 0) {
            const el = document.createElement('div');
            el.className = 'carta carta-retro';
            el.style.top = '50%'; el.style.left = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            
            // Abilita drag dal mazzo
            setupDraggable(el, 'MAZZO');
            
            slot.appendChild(el);
        }
    }

    // --- SISTEMA DRAG & DROP (Touch & Mouse Unificato) ---
    let draggedElement = null;
    let dragOriginType = null; // 'MAZZO', 'SCARTI', 'MANO'
    let dragOriginIndex = null;
    let dragClone = null;
    let startX, startY;

    function setupDraggable(element, type) {
        element.addEventListener('mousedown', startDrag);
        element.addEventListener('touchstart', startDrag, {passive: false});
        
        // Salviamo i dati nell'elemento DOM per recuperarli
        element.dataset.type = type;
    }

    function startDrag(e) {
        if(partitaFinita || giocatori[turnoIndice].tipo !== 'UMANO') return;
        
        e.preventDefault(); // Previene selezione testo o scroll
        
        const type = e.target.dataset.type;
        
        // CONTROLLI REGOLE
        if(faseTurno === 'PESCA') {
            if(type === 'MANO') return; // Non posso muovere carte mano se devo pescare
        } else if (faseTurno === 'SCARTO') {
            if(type !== 'MANO') return; // Posso muovere solo carte mano
        }

        // Init Drag
        draggedElement = e.target;
        dragOriginType = type;
        dragOriginIndex = e.target.dataset.index; // Solo per mano

        // Posizione iniziale pointer
        const point = e.touches ? e.touches[0] : e;
        startX = point.clientX;
        startY = point.clientY;

        // Creiamo un clone visivo da muovere
        dragClone = draggedElement.cloneNode(true);
        dragClone.classList.add('carta-dragging');
        // Impostiamo posizione iniziale clone
        const rect = draggedElement.getBoundingClientRect();
        dragClone.style.left = rect.left + 'px';
        dragClone.style.top = rect.top + 'px';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.height = rect.height + 'px';
        
        document.body.appendChild(dragClone);

        // Nascondiamo originale temporaneamente (opzionale, ma meglio lasciare visibile o semitrasparente)
        draggedElement.style.opacity = '0.5';

        // Listeners movimento globale
        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('touchmove', moveDrag, {passive: false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function moveDrag(e) {
        if(!dragClone) return;
        e.preventDefault();
        const point = e.touches ? e.touches[0] : e;
        
        // Muovi il clone
        const dx = point.clientX - startX;
        const dy = point.clientY - startY;
        
        // Usiamo translate per performance
        // PerÃ² siccome abbiamo settato top/left iniziali, dobbiamo aggiornare quelli o usare transform
        // Aggiorniamo top/left per semplicitÃ 
        dragClone.style.left = (parseFloat(dragClone.style.left) + (point.clientX - startX)) + 'px';
        dragClone.style.top = (parseFloat(dragClone.style.top) + (point.clientY - startY)) + 'px';
        
        startX = point.clientX;
        startY = point.clientY;
    }

    function endDrag(e) {
        if(!dragClone) return;
        
        // Rimuovi listeners
        document.removeEventListener('mousemove', moveDrag);
        document.removeEventListener('touchmove', moveDrag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);

        // Controllo Collisioni (Dove ho lasciato la carta?)
        const cloneRect = dragClone.getBoundingClientRect();
        const centerX = cloneRect.left + cloneRect.width/2;
        const centerY = cloneRect.top + cloneRect.height/2;

        // Zone Target
        const zonaMano = document.getElementById('carte-g0').getBoundingClientRect();
        const zonaScarti = document.getElementById('slot-scarti').getBoundingClientRect();
        
        let azioneCompletata = false;

        // CASO 1: PESCA (Sto trascinando Mazzo o Scarti verso la Mano)
        if(faseTurno === 'PESCA' && (dragOriginType === 'MAZZO' || dragOriginType === 'SCARTI')) {
            // Se il centro della carta Ã¨ vicino alla mano
            if(isInside(centerX, centerY, zonaMano)) {
                eseguiPesca(dragOriginType);
                azioneCompletata = true;
            }
        }

        // CASO 2: SCARTO (Sto trascinando dalla Mano verso Scarti)
        if(faseTurno === 'SCARTO' && dragOriginType === 'MANO') {
            if(isInside(centerX, centerY, zonaScarti)) {
                eseguiScarto(dragOriginIndex);
                azioneCompletata = true;
            }
        }

        // Cleanup
        dragClone.remove();
        dragClone = null;
        if(draggedElement) draggedElement.style.opacity = '1';
        draggedElement = null;

        if(!azioneCompletata) {
            // Animazione "torna indietro" (opzionale, qui non implementata per brevitÃ )
        }
    }

    function isInside(x, y, rect) {
        // Aumentiamo un po' la tolleranza (+50px)
        const margin = 50;
        return x >= rect.left - margin && x <= rect.right + margin &&
               y >= rect.top - margin && y <= rect.bottom + margin;
    }

    // --- ESECUZIONE AZIONI ---
    function eseguiPesca(sorgente) {
        const g = giocatori[0];
        if(sorgente === 'MAZZO') {
            if(mazzo.length === 0) rimescolaMazzo();
            g.mano.push(mazzo.pop());
            aggiornaGraficaMazzo();
        } else {
            g.mano.push(scarti.pop());
            aggiornaGraficaScarti();
        }
        faseTurno = 'SCARTO';
        aggiornaManoUI(g);
        document.getElementById('tutorial').innerText = "Trascina una carta dalla tua mano agli SCARTI.";
    }

    function eseguiScarto(index) {
        const g = giocatori[0];
        const c = g.mano.splice(index, 1)[0];
        scarti.push(c);
        
        faseTurno = 'PESCA'; // Per prossimo turno (anche se qui passa subito)
        aggiornaManoUI(g);
        aggiornaGraficaScarti();
        
        // Controllo vittoria immediata
        if(calcolaPunteggio(g.mano) === 31) {
            chiudiPartita("HAI FATTO 31!");
        } else {
            passaTurno();
            document.getElementById('tutorial').innerText = "Attendi il tuo turno...";
        }
    }

    function rimescolaMazzo() {
        const ultima = scarti.pop();
        mazzo = scarti;
        mazzo.sort(() => Math.random() - 0.5);
        scarti = [ultima];
        aggiornaGraficaScarti();
        aggiornaGraficaMazzo();
    }

    // --- SISTEMA BUSSATA ---
    function setupBussata() {
        const zona = document.getElementById('zona-bussa');
        zona.addEventListener('click', gestisciClickBussa);
        zona.addEventListener('touchstart', (e) => { e.preventDefault(); gestisciClickBussa(); });
    }

    function gestisciClickBussa() {
        if(partitaFinita || giocatori[turnoIndice].tipo !== 'UMANO') return;
        // Non si puÃ² bussare se devi ancora scartare (regola comune: bussi all'inizio o alla fine? Di solito bussi E chiudi. Facciamo che bussi quando hai 4 carte prima di scartare o quando ne hai 3? 
        // Implementazione classica: Bussata = Stop del gioco.
        
        contaBussate++;
        
        clearTimeout(timerBussata);
        timerBussata = setTimeout(() => {
            contaBussate = 0; // Reset se troppo lento
        }, 800); // 800ms per fare 4 click

        if(contaBussate >= 4) {
            triggerAnimazioneBussa();
            contaBussate = 0;
            setTimeout(() => {
                chiudiPartita("HAI BUSSATO!");
            }, 1000);
        }
    }

    function triggerAnimazioneBussa() {
        const anim = document.getElementById('animazione-bussata');
        anim.style.display = 'block';
        anim.style.animation = 'knockAnim 0.5s ease';
        setTimeout(() => { anim.style.display = 'none'; anim.style.animation = ''; }, 500);
    }

    let partitaFinita = false;
    function chiudiPartita(msg) {
        partitaFinita = true;
        document.getElementById('overlay-msg').style.display = 'flex';
        document.getElementById('msg-text').innerHTML = msg;
        
        // Mostra carte di tutti
        giocatori.forEach(g => {
            if(g.tipo === 'BOT') aggiornaManoUI(g);
        });
    }
    
    // Funzione helper per abilitare drag
    function abilitareDrag(bool) {
        // La logica Ã¨ gestita dentro startDrag controllando il turno
    }

</script>
</body>
</html>