<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco 31 - Versione Completa</title>
    <style>
        /* --- STILE GENERALE E TAVOLO --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            overflow: hidden; /* Evita barre di scorrimento */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #tavolo-gioco {
            position: relative;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, #388e3c 0%, #1b5e20 100%); /* Effetto panno verde realistico */
            border-radius: 50%;
            border: 20px solid #5d4037; /* Bordo in legno */
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- CENTRO DEL TAVOLO (Mazzo e Scarti) --- */
        #area-centrale {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 140px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 10px;
        }

        .slot-mazzo, .slot-scarti {
            width: 70px;
            height: 110px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.2);
            position: relative;
        }

        .etichetta-centro {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #ccc;
        }

        /* --- GIOCATORI --- */
        .giocatore {
            position: absolute;
            width: 160px;
            height: 160px;
            transform: translate(-50%, -50%); /* Centra l'elemento sulle coordinate */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
        }

        .avatar {
            width: 60px;
            height: 60px;
            background: #fff;
            border: 3px solid #333;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .info-giocatore {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 15px;
            margin-top: -10px;
            z-index: 3;
            text-align: center;
            font-size: 14px;
            min-width: 80px;
        }

        .turno-attivo .avatar {
            border-color: #ffeb3b; /* Giallo quando è il turno */
            box-shadow: 0 0 15px #ffeb3b;
        }

        /* --- CARTE (SPRITE SHEET) --- */
        .area-carte {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            height: 120px;
            position: relative;
            z-index: 10;
        }

        .carta {
            width: 60px;
            height: 100px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c4/Carte_napoletane_al_completo.jpg');
            background-size: 600px 400px; /* Adattato per l'immagine 10col x 4righe */
            border-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s, margin 0.2s;
            background-color: white;
            position: relative;
            display: inline-block;
            margin-left: -25px; /* Effetto ventaglio */
        }

        .carta:first-child { margin-left: 0; }
        
        /* Effetto hover solo per il giocatore umano */
        .giocatore-umano .carta:hover {
            transform: translateY(-15px) scale(1.1);
            z-index: 20;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .carta-retro {
            background-image: none;
            background: repeating-linear-gradient(
                45deg,
                #606dbc,
                #606dbc 10px,
                #465298 10px,
                #465298 20px
            );
            border: 2px solid white;
        }

        .carta-selezionata {
            border: 3px solid #ffeb3b;
            transform: translateY(-20px) !important;
        }

        /* --- CONTROLLI UTENTE --- */
        #pannello-comandi {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            text-transform: uppercase;
        }

        .btn-pesca { background-color: #2196F3; color: white; }
        .btn-scarta { background-color: #F44336; color: white; }
        .btn-bussa { background-color: #FF9800; color: white; }
        
        button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }

        /* --- MESSAGGI DI GIOCO --- */
        #messaggio-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* Nascosto di default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
            text-align: center;
        }

        #messaggio-testo { font-size: 40px; margin-bottom: 20px; color: #ffeb3b; }
        #log-partite {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
        }

    </style>
</head>
<body>

    <div id="log-partite">Log Partita:<br></div>

    <div id="tavolo-gioco">
        
        <div id="area-centrale">
            <div class="slot-mazzo" id="mazzo-coperto" onclick="giocatorePescaMazzo()">
                <div class="carta carta-retro" style="width:100%; height:100%; margin:0;"></div>
                <div class="etichetta-centro">MAZZO</div>
            </div>
            <div class="slot-scarti" id="pozzetto-scarti" onclick="giocatorePescaScarti()">
                <div class="etichetta-centro">SCARTI</div>
            </div>
        </div>

        </div>

    <div id="pannello-comandi">
        <button id="btn-pesca-mazzo" class="btn-pesca" onclick="giocatorePescaMazzo()">Pesca Mazzo</button>
        <button id="btn-pesca-scarti" class="btn-pesca" onclick="giocatorePescaScarti()">Pesca Scarti</button>
        <button id="btn-scarta" class="btn-scarta" onclick="giocatoreScarta()" disabled>Scarta</button>
        <button id="btn-bussa" class="btn-bussa" onclick="giocatoreBussa()">BUSSA (Chiudi)</button>
    </div>

    <div id="messaggio-overlay">
        <div id="messaggio-testo">VITTORIA!</div>
        <button onclick="location.reload()" style="background:white; color:black;">Gioca Ancora</button>
    </div>

<script>
    /**
     * CONFIGURAZIONE E VARIABILI GLOBALI
     */
    const semi = ['denari', 'coppe', 'bastoni', 'spade'];
    const valori = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; // 8=Fante, 9=Cavallo, 10=Re
    
    let mazzo = [];
    let pilaScarti = [];
    let giocatori = []; // Array di oggetti giocatore
    let indiceGiocatoreCorrente = 0;
    let faseTurno = 'PESCA'; // 'PESCA' o 'SCARTO'
    let partitaFinita = false;

    // --- CLASSE CARTA ---
    class Carta {
        constructor(seme, rank) {
            this.seme = seme;
            this.rank = rank;
            this.id = Math.random().toString(36).substr(2, 9); // ID univoco
        }

        // Calcola il valore per il gioco del 31
        getValorePunti() {
            if (this.rank === 1) return 11; // Asso
            if (this.rank >= 8) return 10;  // Figure
            return this.rank;               // Numeri
        }
    }

    /**
     * INIZIALIZZAZIONE GIOCO
     */
    window.onload = function() {
        iniziaPartita();
    };

    function iniziaPartita() {
        log("Inizio nuova partita...");
        mazzo = creaMazzo();
        pilaScarti = [];
        partitaFinita = false;
        
        // Creazione 4 Giocatori
        giocatori = [
            { nome: "TU (Umano)", tipo: "UMANO", mano: [], punteggio: 0, divId: "p0" },
            { nome: "Mario (CPU)", tipo: "BOT", mano: [], punteggio: 0, divId: "p1" },
            { nome: "Luigi (CPU)", tipo: "BOT", mano: [], punteggio: 0, divId: "p2" },
            { nome: "Peach (CPU)", tipo: "BOT", mano: [], punteggio: 0, divId: "p3" }
        ];

        // Distribuzione Carte (3 a testa)
        for (let i = 0; i < 3; i++) {
            giocatori.forEach(g => pescaoDaMazzo(g));
        }

        // Prima carta nel pozzo degli scarti
        const primaScartata = mazzo.pop();
        pilaScarti.push(primaScartata);

        aggiornaGraficaTavolo();
        aggiornaPilaScartiGrafica();
        gestisciTurno();
    }

    function creaMazzo() {
        let m = [];
        semi.forEach(s => {
            valori.forEach(v => {
                m.push(new Carta(s, v));
            });
        });
        // Mescola (Algoritmo Fisher-Yates)
        for (let i = m.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [m[i], m[j]] = [m[j], m[i]];
        }
        return m;
    }

    /**
     * LOGICA DEL PUNTEGGIO (FIXED BUG)
     * Calcola il punteggio massimo sommando SOLO carte dello stesso seme.
     */
    function calcolaPunteggio(mano) {
        let puntiPerSeme = { 'denari': 0, 'coppe': 0, 'bastoni': 0, 'spade': 0 };
        
        // Conta punti per ogni seme
        mano.forEach(c => {
            puntiPerSeme[c.seme] += c.getValorePunti();
        });

        // Trova il massimo
        let max = 0;
        for (let s in puntiPerSeme) {
            if (puntiPerSeme[s] > max) max = puntiPerSeme[s];
        }

        // Controllo speciale: 3 carte dello stesso valore (es. tre 7) = 30.5 punti (Regola opzionale spesso usata)
        // Ma per ora atteniamoci al "31" classico (stesso seme).
        return max;
    }

    /**
     * GESTIONE TURNI E FLUSSO
     */
    function gestisciTurno() {
        if (partitaFinita) return;

        const giocatore = giocatori[indiceGiocatoreCorrente];
        const uiDiv = document.getElementById(giocatore.divId);
        
        // Evidenzia visivamente chi sta giocando
        document.querySelectorAll('.giocatore').forEach(d => d.classList.remove('turno-attivo'));
        if(uiDiv) uiDiv.classList.add('turno-attivo');

        log(`Turno di: ${giocatore.nome}`);

        // Calcola punteggio attuale
        giocatore.punteggio = calcolaPunteggio(giocatore.mano);
        aggiornaInfoPunteggio(indiceGiocatoreCorrente);

        // Controllo vittoria immediata (31)
        if (giocatore.punteggio === 31) {
            finePartita(giocatore.nome + " ha fatto 31!");
            return;
        }

        if (giocatore.tipo === "UMANO") {
            abilitaControlliUmano(true);
        } else {
            abilitaControlliUmano(false); // Disabilita bottoni mentre gioca il bot
            setTimeout(() => botGioca(giocatore), 1500); // Ritardo per realismo
        }
    }

    function passaTurno() {
        indiceGiocatoreCorrente++;
        if (indiceGiocatoreCorrente >= giocatori.length) indiceGiocatoreCorrente = 0;
        faseTurno = 'PESCA';
        gestisciTurno();
    }

    /**
     * AZIONI DI GIOCO (LOGICA COMUNE)
     */
    function pescaoDaMazzo(giocatore) {
        if (mazzo.length === 0) {
            // Se mazzo finito, rimescola gli scarti (tranne l'ultimo)
            log("Mazzo finito! Rimescolo scarti.");
            const ultima = pilaScarti.pop();
            mazzo = pilaScarti; // Gli scarti diventano mazzo (dovrebbero essere mescolati)
            mazzo.sort(() => Math.random() - 0.5);
            pilaScarti = [ultima];
        }
        const carta = mazzo.pop();
        giocatore.mano.push(carta);
        return carta;
    }

    function pescaDaScarti(giocatore) {
        if (pilaScarti.length === 0) return;
        const carta = pilaScarti.pop();
        giocatore.mano.push(carta);
        return carta;
    }

    /**
     * AZIONI GIOCATORE UMANO
     */
    let cartaSelezionataIndex = -1;

    function abilitaControlliUmano(abilita) {
        document.getElementById('btn-pesca-mazzo').disabled = !abilita || faseTurno !== 'PESCA';
        document.getElementById('btn-pesca-scarti').disabled = !abilita || faseTurno !== 'PESCA';
        document.getElementById('btn-bussa').disabled = !abilita || faseTurno !== 'PESCA';
        
        // Il tasto scarta si abilita solo se ho selezionato una carta E sono in fase di scarto
        document.getElementById('btn-scarta').disabled = true; 
    }

    // Funzioni collegate ai bottoni HTML
    window.giocatorePescaMazzo = function() {
        if (indiceGiocatoreCorrente !== 0 || faseTurno !== 'PESCA') return;
        pescaoDaMazzo(giocatori[0]);
        faseTurno = 'SCARTO';
        aggiornaManoUmano();
        abilitaControlliUmano(true);
        log("Hai pescato dal mazzo.");
    };

    window.giocatorePescaScarti = function() {
        if (indiceGiocatoreCorrente !== 0 || faseTurno !== 'PESCA') return;
        pescaDaScarti(giocatori[0]);
        faseTurno = 'SCARTO';
        aggiornaManoUmano();
        aggiornaPilaScartiGrafica();
        abilitaControlliUmano(true);
        log("Hai pescato dagli scarti.");
    };

    window.selezionaCartaUmano = function(index) {
        if (indiceGiocatoreCorrente !== 0 || faseTurno !== 'SCARTO') return;
        cartaSelezionataIndex = index;
        
        // Aggiorna grafica selezione
        const carteDom = document.querySelectorAll('#p0 .carta');
        carteDom.forEach((c, i) => {
            if (i === index) c.classList.add('carta-selezionata');
            else c.classList.remove('carta-selezionata');
        });

        document.getElementById('btn-scarta').disabled = false;
    };

    window.giocatoreScarta = function() {
        if (cartaSelezionataIndex === -1) return;
        
        const g = giocatori[0];
        const cartaScartata = g.mano.splice(cartaSelezionataIndex, 1)[0]; // Rimuove carta
        pilaScarti.push(cartaScartata);
        
        log(`Hai scartato: ${cartaScartata.rank} di ${cartaScartata.seme}`);
        
        cartaSelezionataIndex = -1;
        aggiornaManoUmano();
        aggiornaPilaScartiGrafica();
        passaTurno();
    };

    window.giocatoreBussa = function() {
        if (indiceGiocatoreCorrente !== 0) return;
        finePartita("Hai Bussato!");
    }

    /**
     * INTELLIGENZA ARTIFICIALE (BOT)
     */
    function botGioca(bot) {
        log(`Bot ${bot.nome} sta pensando...`);

        // 1. DECISIONE PESCA
        // Il bot guarda se la carta negli scarti gli serve per aumentare il punteggio
        const cartaInScarti = pilaScarti[pilaScarti.length - 1];
        let haPescatoScarti = false;

        if (cartaInScarti) {
            // Simuliamo: se la prendo, il mio punteggio migliora?
            let manoSimulata = [...bot.mano, cartaInScarti];
            let scoreAttuale = calcolaPunteggio(bot.mano);
            let scorePotenziale = calcolaPunteggio(manoSimulata); // Nota: qui la mano ha 4 carte, il calcolo deve essere furbo

            // Semplificazione: se la carta vale 10 o 11 ed è del mio seme migliore, la prendo
            if (scorePotenziale > scoreAttuale) {
                pescaDaScarti(bot);
                haPescatoScarti = true;
                log(`${bot.nome} pesca dagli scarti.`);
            }
        }

        if (!haPescatoScarti) {
            pescaoDaMazzo(bot);
            log(`${bot.nome} pesca dal mazzo.`);
        }

        // 2. DECISIONE SCARTO
        // Il bot deve scartare la carta che massimizza il punteggio delle restanti 3
        let migliorPunteggioRimasto = -1;
        let indiceDaScartare = 0;

        for (let i = 0; i < bot.mano.length; i++) {
            // Crea una copia della mano senza la carta i
            let manoTest = bot.mano.filter((_, idx) => idx !== i);
            let p = calcolaPunteggio(manoTest);
            if (p > migliorPunteggioRimasto) {
                migliorPunteggioRimasto = p;
                indiceDaScartare = i;
            }
        }

        const scartata = bot.mano.splice(indiceDaScartare, 1)[0];
        pilaScarti.push(scartata);
        log(`${bot.nome} scarta una carta.`);
        
        aggiornaPilaScartiGrafica();
        aggiornaGraficaBot(bot); // Mostra numero carte o animazione

        // Il bot può bussare? Diciamo se ha più di 28 punti
        if (calcolaPunteggio(bot.mano) >= 28) {
            log(`${bot.nome} tenta di bussare!`);
            // Qui potresti implementare la logica del "last turn"
        }

        setTimeout(passaTurno, 1000);
    }

    /**
     * GESTIONE GRAFICA E SPRITES
     */
    function aggiornaGraficaTavolo() {
        const tavolo = document.getElementById('tavolo-gioco');
        
        // Rimuovi vecchi giocatori se esistono, tranne area centrale
        document.querySelectorAll('.giocatore').forEach(e => e.remove());

        // Parametri cerchio
        const raggio = 320; 
        const centroX = 400; 
        const centroY = 400;

        giocatori.forEach((g, i) => {
            const div = document.createElement('div');
            div.className = 'giocatore';
            div.id = g.divId;
            if (i === 0) div.classList.add('giocatore-umano');

            // Posizionamento Circolare
            // Umano (i=0) a 90 gradi (in basso), poi senso orario
            // Angolo in radianti. 0 è a destra. 
            // Vogliamo: 0->90°(basso), 1->180°(sx), 2->270°(alto), 3->360°/0(dx)
            // Formula corretta per layout orario partendo dal basso:
            const angoli = [90, 180, 270, 0]; 
            const rad = angoli[i] * (Math.PI / 180);
            
            const x = centroX + raggio * Math.cos(rad); // Nota: cos per X
            const y = centroY + raggio * Math.sin(rad); // Nota: sin per Y

            // Piccola correzione per i laterali per non uscire dallo schermo se rettangolare
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;

            // HTML Interno
            div.innerHTML = `
                <div class="avatar">
                    <div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#333;">
                        ${g.nome.charAt(0)}
                    </div>
                </div>
                <div class="info-giocatore">
                    <div>${g.nome}</div>
                    <div id="score-${i}">Pt: ${g.punteggio}</div>
                </div>
                <div class="area-carte" id="carte-${i}"></div>
            `;
            
            tavolo.appendChild(div);
            
            // Renderizza carte iniziali
            if(i === 0) aggiornaManoUmano();
            else aggiornaGraficaBot(g);
        });
    }

    function generaHtmlCarta(carta, isFronte, onClickIndex = -1) {
        const el = document.createElement('div');
        el.className = 'carta';
        if (!isFronte) {
            el.classList.add('carta-retro');
            return el;
        }

        // Logica Sprite
        const w = 60; // Larghezza carta CSS
        const h = 100; // Altezza carta CSS
        
        const semiMap = { 'denari': 0, 'coppe': 1, 'bastoni': 2, 'spade': 3 };
        const sIdx = semiMap[carta.seme];
        const rIdx = carta.rank - 1;

        el.style.backgroundPosition = `-${rIdx * w}px -${sIdx * h}px`;
        
        if (onClickIndex >= 0) {
            el.onclick = () => selezionaCartaUmano(onClickIndex);
        }

        return el;
    }

    function aggiornaManoUmano() {
        const container = document.getElementById('carte-0');
        container.innerHTML = '';
        giocatori[0].mano.forEach((c, index) => {
            container.appendChild(generaHtmlCarta(c, true, index));
        });
        
        // Aggiorna anche il punteggio a video
        giocatori[0].punteggio = calcolaPunteggio(giocatori[0].mano);
        aggiornaInfoPunteggio(0);
    }

    function aggiornaGraficaBot(bot) {
        // I bot mostrano il retro delle carte
        // Troviamo l'indice nell'array giocatori
        const index = giocatori.indexOf(bot);
        const container = document.getElementById(`carte-${index}`);
        if(!container) return;
        
        container.innerHTML = '';
        bot.mano.forEach(() => {
            container.appendChild(generaHtmlCarta(null, false));
        });
        
        // Aggiorna punteggio (opzionale: nasconderlo per realismo?)
        // Per debug lo lasciamo visibile
        aggiornaInfoPunteggio(index);
    }

    function aggiornaPilaScartiGrafica() {
        const divScarti = document.getElementById('pozzetto-scarti');
        // Pulisce tutto tranne l'etichetta
        const label = divScarti.querySelector('.etichetta-centro');
        divScarti.innerHTML = '';
        divScarti.appendChild(label);

        if (pilaScarti.length > 0) {
            const topCard = pilaScarti[pilaScarti.length - 1];
            const el = generaHtmlCarta(topCard, true);
            el.style.margin = '5px'; // Centratura
            divScarti.appendChild(el);
        }
    }

    function aggiornaInfoPunteggio(playerIndex) {
        const el = document.getElementById(`score-${playerIndex}`);
        if(el) el.innerText = `Pt: ${giocatori[playerIndex].punteggio}`;
    }

    function log(msg) {
        const l = document.getElementById('log-partite');
        l.innerHTML += `> ${msg}<br>`;
        l.scrollTop = l.scrollHeight;
        console.log(msg);
    }

    function finePartita(motivo) {
        partitaFinita = true;
        
        // Calcola vincitore
        let vincitore = null;
        let maxScore = -1;
        
        giocatori.forEach(g => {
            // Ricalcola per sicurezza
            const s = calcolaPunteggio(g.mano);
            if (s > maxScore) {
                maxScore = s;
                vincitore = g;
            }
        });

        // Mostra overlay
        const overlay = document.getElementById('messaggio-overlay');
        const testo = document.getElementById('messaggio-testo');
        overlay.style.display = 'flex';
        testo.innerHTML = `${motivo}<br><span style="font-size:24px">Vince ${vincitore.nome} con ${maxScore} punti!</span>`;
        
        // Mostra le carte di tutti
        giocatori.forEach((g, i) => {
            if(i !== 0) { // L'umano le vede già
                const container = document.getElementById(`carte-${i}`);
                container.innerHTML = '';
                g.mano.forEach(c => container.appendChild(generaHtmlCarta(c, true)));
            }
        });
    }

</script>
</body>
</html>